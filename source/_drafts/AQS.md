---
title: AQS
tags:
  - Java
categories:
  - Java
---

AQS即同步器，用于构建锁和同步器的抽象类，使用AQS能简单且高效地构建出应用广泛的大量的同步器。
AQS核心思想：如果被请求的共享资源空闲，则把当前请求的线程设置为有效的线程，并且把共享资源的状态设置为锁定。如果被请求的共享资源被占用，那么就需要一套线程阻塞等待以及被唤醒时锁分配的机制（CLH队列，即将暂时获取不到锁的线程加入到队列中）。
CLH队列是一个虚拟的双向队列，即不存在队列实例，仅存在节点间的关联关系。
AQS把每条请求共享资源的线程封装成一个CLH锁队列的一个节点来实现锁的分配。
AQS通过volatile int成员变量来标识同步状态，使用CAS对该同步状态进行原子操作实现值的修改。通过FIFO队列来完成获取资源线程的排队工作
AQS定义了两种资源共享的方式：独占（只有一个线程能够执行）、共享（多个线程可以同时执行）。独占可以分为公平锁和非公平锁，公平锁：按照线程在队列中的顺序，先到者先拿到锁；非公平锁：无视队列顺序，谁抢到就是谁的。
一般要实现如下方法：
tryAcquire(int)//独占方式。尝试获取资源，成功则返回true，失败则返回false。 tryRelease(int)//独占方式。尝试释放资源，成功则返回true，失败则返回false。 tryAcquireShared(int)//共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源。 
tryReleaseShared(int)//共享方式。尝试释放资源，成功则返回true，失败则返回false。
独占模式下主要实现：tryAcquire和tryRelease，共享模式下主要实现tryAcquireAndShared和tryReleaseShared，一般都是成对使用，也有同时实现使用情形，例如：ReentrantReadWriteLock。